# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ - –§–∏–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ –°–æ–∑–¥–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ (newsletters, newsletter_keywords, newsletter_logs)
2. ‚úÖ –°–æ–∑–¥–∞–Ω—ã –º–æ–¥–µ–ª–∏ (Newsletter, NewsletterKeyword, NewsletterLog)
3. ‚úÖ –°–æ–∑–¥–∞–Ω NewsletterExport –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel
4. ‚úÖ –°–æ–∑–¥–∞–Ω—ã view (newsletters/index.blade.php, emails/newsletter.blade.php)
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ä–æ—É—Ç—ã –≤ routes/web.php
6. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ bootstrap/app.php
7. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
8. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –≤ –º–æ–¥–µ–ª—å User

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### 1. –î–µ–ø–ª–æ–π –∫–æ–¥–∞

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
git add .
git commit -m "–î–æ–±–∞–≤–ª–µ–Ω —Å–µ—Ä–≤–∏—Å —Ä–∞—Å—Å—ã–ª–æ–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º

ü§ñ Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>"
git push origin main

# –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–µ—Ä–≤–µ—Ä–µ
ssh XBMC
cd /home/alex/businessdb
git pull origin main
```

### 2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ temp –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

–ò–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –≤ Docker, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –≤ `temp_newsletter_files/`:

```bash
cd /home/alex/businessdb
bash COPY_FILES.sh
```

–≠—Ç–æ —Å–∫–æ–ø–∏—Ä—É–µ—Ç:
- `SendNewsletters.php` ‚Üí `app/Console/Commands/`
- `NewsletterMail.php` ‚Üí `app/Mail/`
- `NewsletterController.php` ‚Üí `app/Http/Controllers/`

### 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
php artisan migrate
```

–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã:
- `newsletters`
- `newsletter_keywords`
- `newsletter_logs`

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron (–í–ê–ñ–ù–û!)

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–æ–∫ –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞:

```bash
crontab -e
```

–î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É:

```
* * * * * cd /home/alex/businessdb && php artisan schedule:run >> /dev/null 2>&1
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

```bash
php artisan schedule:list
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

```
newsletters:send .......... Every 3 hours ..... Next Due: ...
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ email (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

–í `.env` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã SMTP:

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.yandex.ru
MAIL_PORT=465
MAIL_USERNAME=no-reply@businessdb.ru
MAIL_PASSWORD=***
MAIL_ENCRYPTION=ssl
MAIL_FROM_ADDRESS=no-reply@businessdb.ru
MAIL_FROM_NAME="BusinessDB"
```

### 6. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è temp —Ñ–∞–π–ª–æ–≤

```bash
mkdir -p storage/app/temp
chmod 755 storage/app/temp
```

### 7. –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞

```bash
php artisan optimize:clear
sudo systemctl restart php8.3-fpm
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏

```bash
# –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞–º–µ–Ω–∏—Ç–µ 1 –Ω–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
php artisan newsletters:send --user_id=1
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
tail -f storage/logs/laravel.log
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
php artisan tinker
```

```php
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü
\App\Models\Newsletter::count();
\App\Models\NewsletterKeyword::count();
\App\Models\NewsletterLog::count();

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
$newsletter = \App\Models\Newsletter::create([
    'user_id' => 1,
    'is_active' => true,
]);

$newsletter->keywords()->create([
    'keywords' => '–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ microsoft'
]);

// –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
\Artisan::call('newsletters:send', ['--user_id' => 1]);
```

## üì± –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É **"–†–∞—Å—Å—ã–ª–∫–∏"** –≤ –º–µ–Ω—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
2. –í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É (—á–µ–∫–±–æ–∫—Å "–í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É")
3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–∫–∞–∑–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π email
4. –î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –Ω–∞–±–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤)
5. –ù–∞–∂–∞—Ç—å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"

### –§–æ—Ä–º–∞—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤:

–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è OR –∑–∞–ø—Ä–æ—Å–∞:
```
–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ microsoft
–∫–æ–º–ø—å—é—Ç–µ—Ä—ã –Ω–æ—É—Ç–±—É–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä—ã
–º–µ–±–µ–ª—å –æ—Ñ–∏—Å–Ω–∞—è
```

–≠—Ç–æ –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å –∑–∞–∫—É–ø–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ:
- "–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ" OR "–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ" OR "microsoft"
- "–∫–æ–º–ø—å—é—Ç–µ—Ä—ã" OR "–Ω–æ—É—Ç–±—É–∫–∏" OR "–ø—Ä–∏–Ω—Ç–µ—Ä—ã"
- "–º–µ–±–µ–ª—å" OR "–æ—Ñ–∏—Å–Ω–∞—è"

### –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ä–∞—Å—Å—ã–ª–∫–∏:

- –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ (00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00)
- –¢–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (`is_active = true`)
- –ü–æ–∏—Å–∫ –∑–∞–∫—É–ø–æ–∫ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏
- –ï—Å–ª–∏ –∑–∞–∫—É–ø–æ–∫ –Ω–µ—Ç - –ø–∏—Å—å–º–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (–Ω–æ `last_sent_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)

### –ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:

- Email —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∑–∞–∫—É–ø–æ–∫
- Excel —Ñ–∞–π–ª —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
  - –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
  - –ü—Ä–µ–¥–º–µ—Ç –∑–∞–∫—É–ø–∫–∏
  - –ù–∞—á–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
  - –ó–∞–∫–∞–∑—á–∏–∫
  - Email, —Ç–µ–ª–µ—Ñ–æ–Ω
  - –ê–¥—Ä–µ—Å
  - –¢–∏–ø –∑–∞–∫—É–ø–∫–∏

## üîß Troubleshooting

### –†–∞—Å—Å—ã–ª–∫–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ cron:
   ```bash
   crontab -l
   php artisan schedule:list
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```bash
   tail -f storage/logs/laravel.log
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ email:
   ```bash
   php artisan tinker
   Mail::raw('Test', function($message) {
       $message->to('your@email.com')->subject('Test');
   });
   ```

### –û—à–∏–±–∫–∞ "Class 'Newsletter' not found"

```bash
composer dump-autoload
php artisan optimize:clear
```

### –û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ storage

```bash
chmod -R 755 storage
chmod -R 755 bootstrap/cache
chown -R alex:www-data storage bootstrap/cache
```

### Email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MAIL_*
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ SMTP –ø–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç:
   ```bash
   telnet smtp.yandex.ru 465
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ email:
   ```bash
   grep -i "mail" storage/logs/laravel.log
   ```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞—Å—Å—ã–ª–∫–∞–º

```sql
-- SQL Admin Panel (https://businessdb.ru/admin/sql)

-- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å–æ–∫
SELECT COUNT(*) as total_newsletters,
       SUM(CASE WHEN is_active THEN 1 ELSE 0 END) as active_newsletters
FROM newsletters;

-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
SELECT DATE(sent_at) as date,
       COUNT(*) as emails_sent,
       SUM(zakupki_count) as total_zakupki,
       SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as successful,
       SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed
FROM newsletter_logs
WHERE sent_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(sent_at)
ORDER BY date DESC;

-- –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
SELECT keywords, COUNT(*) as usage_count
FROM newsletter_keywords
GROUP BY keywords
ORDER BY usage_count DESC
LIMIT 10;
```

### Logs

```bash
# Laravel logs
tail -f storage/logs/laravel.log

# Nginx logs
sudo tail -f /var/log/nginx/businessdb-error.log
sudo tail -f /var/log/nginx/businessdb-access.log
```

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏:**
   - –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
   - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
   - –ú–∞–∫—Å–∏–º—É–º 10 –Ω–∞–±–æ—Ä–æ–≤ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –õ–∏–º–∏—Ç –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫—É–ø–æ–∫ –≤ –æ–¥–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–µ (—Å–µ–π—á–∞—Å 1000)

3. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:**
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫—É–ø–∫–∏
   - –†–µ–≥–∏–æ–Ω—ã (–≥–æ—Ä–æ–¥–∞)
   - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑—á–∏–∫–æ–≤

4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫—É–ø–∫–∞—Ö
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

## ‚úÖ Checklist

- [ ] –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω COPY_FILES.sh
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] Cron –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Email SMTP –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è storage/app/temp —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ö–µ—à –æ—á–∏—â–µ–Ω
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ /newsletters –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- Telegram: @cdvks
- Email: support@businessdb.ru
